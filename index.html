<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YT SOLVE - Kliping Video Otomatis AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #f0f6fc; }
        .gradient-text { background-image: linear-gradient(45deg, #4F46E5, #9333EA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    </style>
</head>
<body class="min-h-screen antialiased">
    <nav class="sticky top-0 z-50 bg-[#0d1117]/95 backdrop-blur-sm shadow-lg border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex justify-between items-center w-full">
                    <div class="flex-shrink-0">
                        <span class="text-2xl font-bold gradient-text">YT SOLVE</span>
                    </div>
                    <p id="authDebug" class="text-xs text-gray-500 hidden md:block">Status Autentikasi: Menggunakan proxy backend untuk panggilan API.</p>
                </div>
            </div>
        </div>
    </nav>

    <main class="py-16">
        <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center mb-16">
            <h1 class="4xl sm:text-5xl font-extrabold mb-4 leading-tight">
                AI Analisis & Rencana Klip
                <span class="gradient-text block text-6xl sm:text-7xl">Konten Viral Instan.</span>
            </h1>
            <p class="text-lg text-gray-400 mb-8 max-w-2xl mx-auto">Masukkan topik atau judul video YouTube Anda. AI kami akan menganalisis konten dan menghasilkan rencana klip secara real-time.</p>

            <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                <input type="text" id="videoTopic" placeholder="Contoh: 'Resep Rendang Daging Sapi Paling Enak'"
                       class="w-full md:w-96 p-3 bg-gray-800 border border-gray-700 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-white placeholder-gray-500 transition" />
                <button id="analyzeBtn" class="w-full md:w-auto px-8 py-3 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500">
                    Analisis Video
                </button>
            </div>

            <div id="loading" class="mt-8 hidden">
                <div class="flex items-center justify-center space-x-2">
                    <div class="w-4 h-4 rounded-full bg-indigo-400 animate-pulse"></div>
                    <div class="w-4 h-4 rounded-full bg-indigo-500 animate-pulse delay-150"></div>
                    <div class="w-4 h-4 rounded-full bg-indigo-600 animate-pulse delay-300"></div>
                    <span class="text-indigo-400 text-sm font-medium">AI Sedang Menganalisis Konten...</span>
                </div>
            </div>

            <p id="errorMsg" class="mt-4 text-red-400 text-sm hidden">Terjadi kesalahan saat memproses. Coba lagi atau gunakan topik yang lebih spesifik.</p>
        </section>

        <section id="resultsContainer" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 border-t border-gray-800 hidden">
            <h2 class="text-3xl font-bold text-center mb-8 gradient-text">ðŸŽ‰ Rencana Klip Viral Anda Siap!</h2>
            <div id="resultContent" class="bg-[#161b22] p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-700"></div>
            <div id="citationSources" class="mt-4 text-xs text-gray-500 text-left"></div>
        </section>
    </main>

    <footer class="bg-[#0d1117] border-t border-gray-800 py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-500">
            <p>&copy; 2025 YT SOLVE. Simulasi Kliping Video AI Real-time (Analisis Data Google Search).</p>
        </div>
    </footer>

    <script>
        // NOTE: API KEY now stored in backend proxy (do not put key here)
        const apiUrl = "/api/generate";

        const videoTopicInput = document.getElementById('videoTopic');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingIndicator = document.getElementById('loading');
        const errorMsg = document.getElementById('errorMsg');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultContent = document.getElementById('resultContent');
        const citationSources = document.getElementById('citationSources');

        const responseSchema = {
            type: "OBJECT",
            properties: {
                title: { type: "STRING" },
                keyMoments: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            description: { type: "STRING" },
                            recommendedCutStart: { type: "STRING" },
                            recommendedCutEnd: { type: "STRING" }
                        }
                    }
                },
                viralCaption: { type: "STRING" }
            },
            propertyOrdering: ["title", "keyMoments", "viralCaption"]
        };

        async function delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && attempt < maxRetries - 1) {
                        const delayTime = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        console.log('[Proxy] 429, retrying in ' + (delayTime / 1000).toFixed(2) + 's...');
                        await delay(delayTime);
                        continue;
                    }
                    if (!response.ok) {
                        // try to read error body for better debugging
                        let bodyText = await response.text().catch(() => '');
                        console.error(`[Proxy] HTTP error ${response.status}:`, bodyText);
                        const err = new Error("HTTP error! status: " + response.status);
                        err.status = response.status;
                        err.body = bodyText;
                        throw err;
                    }
                    return response;
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        console.error("[Proxy] Failed after all retries:", error);
                        throw error;
                    }
                    // small delay before retry loop continues
                    await delay(500 * (attempt + 1));
                }
            }
        }

        async function analyzeVideo() {
            const topic = videoTopicInput.value.trim();
            if (topic.length < 5) {
                errorMsg.textContent = "Harap masukkan topik video yang lebih deskriptif (minimal 5 karakter).";
                errorMsg.classList.remove('hidden');
                return;
            }

            errorMsg.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            analyzeBtn.disabled = true;

            const systemPrompt = "Anda adalah AI Slicer, spesialis konten video pendek. Tugas Anda adalah menganalisis topik yang diberikan, mencari informasi melalui Google Search jika diperlukan, dan menghasilkan rencana klip (dalam JSON sesuai schema) yang berisi judul, 3 momen kunci dengan waktu perkiraan, dan caption viral.";
            const userQuery = "Analisis dan buat rencana pemotongan video untuk topik ini: \"" + topic + "\". Temukan 3 momen kunci dengan perkiraan durasi dan buatkan caption yang menarik.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];
                const jsonText = candidate?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    throw new Error("Gagal mendapatkan respons JSON dari AI.");
                }

                const parsedData = JSON.parse(jsonText);

                let sourcesHtml = 'Sumber Analisis: ';
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    groundingMetadata.groundingAttributions.forEach((attribution, index) => {
                        if (attribution.web?.uri && attribution.web?.title) {
                            sourcesHtml += `<a href="${attribution.web.uri}" target="_blank" class="text-indigo-400 hover:text-indigo-300 underline mx-1">[${index + 1}: ${attribution.web.title}]</a>`;
                        }
                    });
                } else {
                    sourcesHtml += 'Tidak ada sumber eksternal yang teridentifikasi.';
                }
                citationSources.innerHTML = sourcesHtml;

                renderResults(parsedData);
                resultsContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Kesalahan API atau Jaringan:", error);
                if (error.status === 401 || (error.body && error.body.includes && (error.body.includes("401") || error.body.includes("403")))) {
                    errorMsg.textContent = "Kesalahan Otentikasi (401/403). Periksa konfigurasi API key di backend, aktifkan API & billing, atau periksa pembatasan referrer.";
                } else {
                    errorMsg.textContent = "Gagal memproses analisis. Pastikan topik sudah benar dan koneksi internet stabil.";
                }
                errorMsg.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }

        function renderResults(data) {
            let html = `<div class="space-y-8">`;

            html += `
                <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-indigo-500">
                    <h3 class="text-xl font-semibold mb-2 text-white">Judul Klip Viral Direkomendasikan</h3>
                    <p class="text-2xl font-bold gradient-text">${data.title}</p>
                </div>
            `;

            html += `
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-white">Rencana Pemotongan (Klip 1, 2, 3)</h3>
                    <div class="space-y-4">
            `;

            data.keyMoments.forEach((moment, index) => {
                html += `
                    <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                        <p class="text-lg font-bold text-indigo-400 mb-1">Klip ${index + 1}</p>
                        <p class="text-sm text-gray-400">Poin Kunci: ${moment.description}</p>
                        <p class="text-sm font-mono mt-2 bg-gray-700 inline-block px-2 py-1 rounded-md">
                            Durasi Potong: <span class="text-yellow-400">${moment.recommendedCutStart}</span> hingga <span class="text-yellow-400">${moment.recommendedCutEnd}</span>
                        </p>
                    </div>
                `;
            });

            html += `</div></div>`;

            html += `
                <div class="pt-4 border-t border-gray-700">
                    <h3 class="text-xl font-semibold mb-2 text-white">Caption Siap Posting (TikTok/Reels)</h3>
                    <p class="text-gray-300 whitespace-pre-wrap p-4 bg-gray-800 rounded-lg shadow-inner">${data.viralCaption}</p>
                </div>
            `;

            html += `</div>`;
            resultContent.innerHTML = html;
        }

        analyzeBtn.addEventListener('click', analyzeVideo);
    </script>
</body>
</html>
